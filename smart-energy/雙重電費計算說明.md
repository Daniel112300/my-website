# 雙重電費計算說明

## 📊 設計概念

您的系統現在**同時記錄兩種電費**：

### 1. 設備邊際電費（Device Marginal Cost）
- **儲存位置**：CSV 的 `cost` 欄位
- **計算方式**：基於月累積用電量，計算這筆新增後的電費差額
- **用途**：了解每個設備在當下時間點的「真實用電成本」

### 2. 當天累進電費（Daily Progressive Cost）
- **儲存位置**：API 回傳，可額外儲存
- **計算方式**：當天所有設備用電加總後，用累進費率計算
- **用途**：了解當天整體的用電成本（符合台電實際計費）

---

## 🔍 三個 API 的功能

### 1️⃣ `POST /add` - 新增用電紀錄

**輸入**：
```json
{
  "device_id": 1,
  "kwh": 5.1,
  "day": "2025-11-14"
}
```

**輸出**：
```json
{
  "ok": true,
  "new_data": {
    "log_id": 1732867200,
    "device_id": 1,
    "log_date": "2025-11-14",
    "energy_consumed": 5.1,
    "cost": 8.57,              // ← 儲存的設備邊際電費
    "electricity_rate": 1.68,
    "created_at": "2025-11-14 10:00:00"
  },
  "device_analysis": {
    "device_marginal_cost": 8.57,     // 這個設備的邊際電費
    "device_avg_rate": 1.68,          // 這筆的平均費率
    "month_total_kwh_before": 0,      // 月累積（加入前）
    "month_total_kwh_after": 5.1      // 月累積（加入後）
  },
  "daily_analysis": {
    "daily_total_kwh": 5.1,           // 當天總用電量
    "daily_progressive_cost": 8.57,   // 當天累進電費
    "daily_cumulative_bill": 8.57     // 當天累積電費
  }
}
```

---

### 2️⃣ `GET /daily` - 每日用電統計

**輸出**：
```json
{
  "2025-11-14": {
    "kwh": 6.8,                    // 當天總用電量
    "cost_sum": 11.36,             // 各設備電費加總
    "cost_progressive": 11.42,     // 用累進費率重新計算
    "devices": [
      {"device_id": 1, "kwh": 5.1, "cost": 8.57},
      {"device_id": 2, "kwh": 1.5, "cost": 2.52},
      {"device_id": 3, "kwh": 0.2, "cost": 0.27}
    ]
  }
}
```

**說明**：
- `cost_sum`：各設備 `cost` 欄位加總
- `cost_progressive`：當天總用電量（6.8度）用累進費率重新計算
- 兩者可能有些微差異

---

### 3️⃣ `GET /bill` - 月度電費統計

**輸出**：
```json
{
  "total_kwh": 450.5,
  "total_cost_sum": 1234.56,          // 所有設備電費加總
  "total_cost_progressive": 1249.30,   // 用累進費率重新計算
  "months": [
    {
      "month": "2025-11",
      "kwh": 450.5,
      "cost_sum": 1234.56,
      "cost_progressive": 1249.30,
      "season": "非夏月",
      "difference": 14.74               // 兩種算法的差異
    }
  ],
  "billing_method": "台電累進費率",
  "explanation": {
    "cost_sum": "各設備電費加總（邊際費率）",
    "cost_progressive": "月累積用電量重新計算（實際台電帳單）"
  }
}
```

---

## 💡 實際範例

假設 11 月份的用電記錄：

| 日期 | 設備 | 用電量 | 月累積 | 設備邊際電費 |
|------|------|--------|--------|--------------|
| 11/1 | 冷氣 | 50度 | 50度 | $84.00 (50×1.68) |
| 11/2 | 燈具 | 30度 | 80度 | $50.40 (30×1.68) |
| 11/3 | 冷氣 | 50度 | 130度 | $84.50 (混合費率) |

### 計算方式 1：設備邊際電費（儲存在 CSV）
- 11/1：$84.00
- 11/2：$50.40
- 11/3：$84.50
- **加總**：$218.90

### 計算方式 2：當天累進電費
**11/1**：
- 當天總用電：50度
- 累進費率：50×1.68 = $84.00

**11/2**：
- 當天總用電：30度
- 月累積：50→80度
- 累進費率：(80×1.68) - (50×1.68) = $50.40

**11/3**：
- 當天總用電：50度
- 月累積：80→130度
- 累進費率：計算差額 = $84.50

### 月底重算（計算方式 3）
- 月總用電：130度
- 直接用累進費率：130×1.68 = **$218.40**
- 與加總相比：$218.90（邊際） vs $218.40（重算）
- 差異：$0.50（因為四捨五入）

---

## 🎯 使用建議

### 何時用「設備邊際電費」？
- 想知道「現在多用一度電要花多少錢」
- 比較不同設備的用電成本
- 做即時的節電決策

### 何時用「累進電費重算」？
- 核對台電帳單
- 預測月底電費
- 了解整體用電支出

---

## 📌 資料儲存說明

### CSV 檔案（power_logs.csv）
```csv
log_id,device_id,log_date,energy_consumed,cost,electricity_rate,created_at
1,1,2025-11-14,5.1,8.57,1.68,2025-11-14 10:00:00
2,2,2025-11-14,1.5,2.52,1.68,2025-11-14 11:00:00
```

- `cost` 欄位儲存的是**設備邊際電費**
- `electricity_rate` 是這筆記錄的**平均費率**

### API 回傳的額外資訊
- `cost_progressive`：累進費率重算的電費
- 這個值**不儲存**在 CSV，而是動態計算

---

## ✅ 優點

1. **彈性**：可以同時看兩種視角
2. **準確**：符合台電累進費率邏輯
3. **即時**：知道邊際成本，幫助節電決策
4. **驗證**：可以對比兩種算法，確保準確性

---

## 🔧 如果想儲存兩種電費

可以在 CSV 新增一個欄位：

```csv
log_id,device_id,log_date,energy_consumed,cost,cost_progressive,electricity_rate,created_at
```

- `cost`：設備邊際電費
- `cost_progressive`：累進費率分攤的電費

需要的話我可以幫您實作！
