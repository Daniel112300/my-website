# å‰ç«¯æ•´åˆæŒ‡å—

## ğŸ“‹ å¾Œç«¯ API å·²å®Œæˆï¼Œç­‰å¾…å‰ç«¯æ•´åˆ

å¾Œç«¯å·²ç¶“å®Œæˆæ‰€æœ‰ API ç«¯é»ï¼Œç›®å‰å›å‚³çš„éƒ½æ˜¯ **JSON æ ¼å¼è³‡æ–™**ã€‚å‰ç«¯çµ„å“¡éœ€è¦ï¼š
1. å»ºç«‹ä½¿ç”¨è€…ä»‹é¢ï¼ˆHTML é é¢ï¼‰
2. å‘¼å«å¾Œç«¯ API å–å¾—è³‡æ–™
3. å°‡ JSON è³‡æ–™æ¸²æŸ“æˆè¡¨æ ¼ã€åœ–è¡¨ã€è¡¨å–®ç­‰

---

## ğŸ”Œ åŠŸèƒ½ 1ï¼šé›»å™¨é–‹é—œç‹€æ…‹èˆ‡é ç«¯æ§åˆ¶

### API ç«¯é»

#### 1.1 æŸ¥çœ‹æ‰€æœ‰è¨­å‚™ç‹€æ…‹
```
GET /device/state
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "state": {
    "å®¢å»³LEDç‡ˆ": false,
    "å®¢å»³å†·æ°£": true,
    "æ›¸æˆ¿æª¯ç‡ˆ": false,
    "æ¸¬è©¦å†·æ°£": false,
    "è‡¥å®¤å†·æ°£": false,
    "é¤å»³ä¸»ç‡ˆ": false
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] åœ¨é¦–é åŠ ä¸Šã€ŒæŸ¥çœ‹è¨­å‚™ç‹€æ…‹ã€æŒ‰éˆ•æˆ–é€£çµ
- [ ] å»ºç«‹è¨­å‚™æ§åˆ¶é é¢ï¼Œé¡¯ç¤ºæ‰€æœ‰è¨­å‚™çš„é–‹é—œç‹€æ…‹
- [ ] æ¯å€‹è¨­å‚™é¡¯ç¤ºä¸€å€‹é–‹é—œæŒ‰éˆ•ï¼ˆToggle Switchï¼‰

#### 1.2 åˆ‡æ›è¨­å‚™é–‹é—œ
```
PATCH /device/toggle
Content-Type: application/json

{
  "name": "å®¢å»³å†·æ°£",
  "on": true
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "state": {
    "å®¢å»³LEDç‡ˆ": false,
    "å®¢å»³å†·æ°£": true,
    ...
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] ç•¶ä½¿ç”¨è€…é»æ“Šé–‹é—œæŒ‰éˆ•æ™‚ï¼Œç™¼é€ PATCH è«‹æ±‚
- [ ] æ›´æ–° UI é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
- [ ] é¡¯ç¤ºæ“ä½œæˆåŠŸ/å¤±æ•—è¨Šæ¯

---

## ğŸ“Š åŠŸèƒ½ 2ï¼šæ¯æ—¥ç”¨é›»èˆ‡é›»è²»çµ±è¨ˆ

### API ç«¯é»

#### 2.1 æ¯æ—¥ç”¨é›»çµ±è¨ˆï¼ˆé è¨­è¿‘ 7 å¤©ï¼‰
```
GET /usage/daily
GET /usage/daily?start_date=2025-11-01&end_date=2025-11-30
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "data": [
    {
      "date": "2025-11-24",
      "total_kwh": 15.23,
      "total_cost": 45.67,
      "avg_rate": 3.00
    },
    {
      "date": "2025-11-25",
      "total_kwh": 18.45,
      "total_cost": 55.23,
      "avg_rate": 2.99
    }
  ],
  "summary": {
    "total_days": 7,
    "total_kwh": 120.45,
    "total_cost": 360.12,
    "avg_daily_kwh": 17.21,
    "avg_daily_cost": 51.45
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œæ¯æ—¥ç”¨é›»çµ±è¨ˆã€é é¢
- [ ] é¡¯ç¤ºæ—¥æœŸé¸æ“‡å™¨ï¼ˆèµ·å§‹æ—¥æœŸã€çµæŸæ—¥æœŸï¼‰
- [ ] ç”¨**æŠ˜ç·šåœ–**é¡¯ç¤ºæ¯æ—¥ç”¨é›»é‡è¶¨å‹¢
- [ ] ç”¨**è¡¨æ ¼**é¡¯ç¤ºè©³ç´°æ•¸æ“š
- [ ] é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦ï¼ˆç¸½ç”¨é›»é‡ã€ç¸½é›»è²»ã€å¹³å‡å€¼ï¼‰

#### 2.2 å–®æœˆç”¨é›»çµ±è¨ˆ
```
GET /usage/monthly/2025/11
GET /usage/monthly/2025/4
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "year": 2025,
  "month": 11,
  "data": [
    {
      "date": "2025-11-01",
      "total_kwh": 12.34,
      "total_cost": 37.02
    },
    ...
  ],
  "summary": {
    "total_days": 30,
    "total_kwh": 450.67,
    "total_cost": 1352.01,
    "avg_daily_kwh": 15.02,
    "avg_daily_cost": 45.07
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œæœˆçµ±è¨ˆã€é é¢
- [ ] é¡¯ç¤ºå¹´ä»½å’Œæœˆä»½é¸æ“‡å™¨ï¼ˆä¾‹å¦‚ï¼š2025 å¹´ 11 æœˆï¼‰
- [ ] ç”¨**é•·æ¢åœ–**é¡¯ç¤ºæ¯æ—¥ç”¨é›»é‡
- [ ] æ¨™è¨»æœ€é«˜/æœ€ä½ç”¨é›»æ—¥
- [ ] é¡¯ç¤ºæœˆç¸½è¨ˆå’Œå¹³å‡å€¼

#### 2.3 å…¨å¹´ç”¨é›»çµ±è¨ˆ
```
GET /usage/yearly/2025
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "year": 2025,
  "data": [
    {
      "month": 1,
      "total_kwh": 350.12,
      "total_cost": 1050.36,
      "days_with_data": 31
    },
    {
      "month": 2,
      "total_kwh": 320.45,
      "total_cost": 961.35,
      "days_with_data": 28
    },
    ...
  ],
  "summary": {
    "total_kwh": 4500.67,
    "total_cost": 13501.99,
    "avg_monthly_kwh": 375.06,
    "avg_monthly_cost": 1125.17
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œå¹´åº¦çµ±è¨ˆã€é é¢
- [ ] é¡¯ç¤ºå¹´ä»½é¸æ“‡å™¨
- [ ] ç”¨**é•·æ¢åœ–**é¡¯ç¤º 12 å€‹æœˆçš„ç”¨é›»é‡å°æ¯”
- [ ] æ¨™è¨»å¤å­£ï¼ˆ6-9æœˆï¼‰å’Œéå¤å­£æœˆä»½ï¼ˆé¡è‰²å€åˆ†ï¼‰
- [ ] é¡¯ç¤ºå¹´ç¸½è¨ˆå’Œæ¯æœˆå¹³å‡

#### 2.4 é›»è²»è©¦ç®—
```
POST /usage/bill
Content-Type: application/json

{
  "kwh": 330,
  "month": 7
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "input": {
    "kwh": 330,
    "month": 7,
    "is_summer": true
  },
  "breakdown": [
    {"tier": 1, "range": "0-120", "kwh": 120, "rate": 1.78, "subtotal": 213.6},
    {"tier": 2, "range": "121-330", "kwh": 210, "rate": 2.55, "subtotal": 535.5}
  ],
  "total_bill": 749.1,
  "avg_rate": 2.27
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œé›»è²»è©¦ç®—ã€é é¢
- [ ] è¼¸å…¥æ¬„ä½ï¼šç”¨é›»åº¦æ•¸ï¼ˆkWhï¼‰ã€æœˆä»½
- [ ] é¡¯ç¤ºæ˜¯å¦ç‚ºå¤å­£é›»åƒ¹
- [ ] ç”¨**å †ç–Šé•·æ¢åœ–**é¡¯ç¤ºåˆ†æ®µè¨ˆè²»
- [ ] é¡¯ç¤ºæ¯å€‹ç´šè·çš„åº¦æ•¸ã€è²»ç‡ã€å°è¨ˆ
- [ ] é¡¯ç¤ºç¸½é›»è²»å’Œå¹³å‡é›»åƒ¹

#### 2.5 æ™‚é–“æ®µæ¯”è¼ƒ
```
GET /usage/compare?period_type=month&date1=2025-10&date2=2025-11
GET /usage/compare?period_type=day&date1=2025-11-01&date2=2025-11-30
GET /usage/compare?period_type=year&date1=2024&date2=2025
```

**åƒæ•¸èªªæ˜**ï¼š
- `period_type`: æ¯”è¼ƒé¡å‹ (`day`, `month`, `year`)
- `date1`: ç¬¬ä¸€å€‹æ™‚é–“é»
  - æ—¥ï¼š`2025-11-01`
  - æœˆï¼š`2025-10`
  - å¹´ï¼š`2025`
- `date2`: ç¬¬äºŒå€‹æ™‚é–“é»ï¼ˆæ ¼å¼åŒ `date1`ï¼‰

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "period_type": "month",
  "period1": {
    "label": "2025-10",
    "kwh": 420.5,
    "cost": 1261.5,
    "record_count": 93
  },
  "period2": {
    "label": "2025-11",
    "kwh": 380.2,
    "cost": 1140.6,
    "record_count": 79
  },
  "comparison": {
    "kwh_difference": -40.3,
    "cost_difference": -120.9,
    "kwh_percent_change": -9.58,
    "cost_percent_change": -9.59
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œæ™‚é–“æ®µæ¯”è¼ƒã€é é¢
- [ ] æä¾›æ¯”è¼ƒé¡å‹é¸æ“‡å™¨ï¼ˆæ—¥/æœˆ/å¹´ï¼‰
- [ ] æä¾›å…©å€‹æ—¥æœŸé¸æ“‡å™¨ï¼ˆæ ¹æ“šæ¯”è¼ƒé¡å‹é¡¯ç¤ºä¸åŒç²¾åº¦ï¼‰
- [ ] ç”¨**ä¸¦æ’é•·æ¢åœ–**æˆ–**é›·é”åœ–**æ¯”è¼ƒ
- [ ] é¡¯ç¤ºå·®ç•°å€¼å’Œç™¾åˆ†æ¯”è®ŠåŒ–ï¼ˆç”¨é¡è‰²å€åˆ†å¢åŠ /æ¸›å°‘ï¼‰
- [ ] é¡¯ç¤ºã€Œç¯€çœã€æˆ–ã€Œå¢åŠ ã€çš„æç¤ºè¨Šæ¯

#### 2.6 æ–°å¢ç”¨é›»è¨˜éŒ„
```
POST /usage/add
Content-Type: application/json

{
  "device_id": 1,
  "kwh": 5.5,
  "date": "2025-11-30"
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "msg": "å·²æ–°å¢ç”¨é›»è¨˜éŒ„",
  "data": {
    "log_id": 123,
    "device_id": 1,
    "power_watts": 3500.0,
    "hours": 1.57,
    "log_date": "2025-11-30",
    "energy_consumed": 5.5,
    "cost": 9.79,
    "electricity_rate": 1.78
  }
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œæ–°å¢ç”¨é›»è¨˜éŒ„ã€è¡¨å–®
- [ ] è¼¸å…¥æ¬„ä½ï¼šè¨­å‚™é¸æ“‡ã€ç”¨é›»åº¦æ•¸ã€æ—¥æœŸ
- [ ] é¡¯ç¤ºæ–°å¢æˆåŠŸè¨Šæ¯
- [ ] å¯é¸ï¼šè‡ªå‹•è¨ˆç®—åŠŸç‡å’Œæ™‚æ•¸ï¼ˆå¦‚æœå·²çŸ¥è¨­å‚™é¡å®šåŠŸç‡ï¼‰

#### 2.7 æ‰¹æ¬¡æ–°å¢ç”¨é›»è¨˜éŒ„
```
POST /usage/batch
Content-Type: application/json

{
  "records": [
    {
      "device_id": 1,
      "kwh": 5.5,
      "date": "2025-11-01"
    },
    {
      "device_id": 2,
      "watts": 1000,
      "hours": 3,
      "date": "2025-11-01"
    },
    {
      "device_id": 3,
      "kwh": 2.3
    }
  ]
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "ok": true,
  "success_count": 3,
  "failure_count": 0,
  "results": [
    {
      "index": 0,
      "success": true,
      "log_id": 124,
      "msg": "å·²æ–°å¢è¨˜éŒ„"
    },
    {
      "index": 1,
      "success": true,
      "log_id": 125,
      "msg": "å·²æ–°å¢è¨˜éŒ„"
    },
    {
      "index": 2,
      "success": true,
      "log_id": 126,
      "msg": "å·²æ–°å¢è¨˜éŒ„"
    }
  ]
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œæ‰¹æ¬¡åŒ¯å…¥ã€åŠŸèƒ½
- [ ] æ”¯æ´ CSV æˆ– Excel æª”æ¡ˆä¸Šå‚³
- [ ] é¡¯ç¤ºåŒ¯å…¥é€²åº¦æ¢
- [ ] é¡¯ç¤ºæˆåŠŸ/å¤±æ•—çµ±è¨ˆ
- [ ] åˆ—å‡ºå¤±æ•—çš„è¨˜éŒ„å’ŒåŸå› 

---

## ğŸŒ¡ï¸ åŠŸèƒ½ 3ï¼šæº«åº¦åˆ¤æ–·èˆ‡è‡ªå‹•æ§åˆ¶

### API ç«¯é»

#### 3.1 æº«åº¦åˆ¤æ–·
```
GET /auto/decide?temp=28
POST /auto/decide
Content-Type: application/json

{
  "temp": 28
}
```

**å›æ‡‰ç¯„ä¾‹ï¼ˆé«˜æº«ï¼‰**ï¼š
```json
{
  "ok": true,
  "action": "turn_on",
  "state": {
    "aircon": true
  },
  "target": 26.0
}
```

**å›æ‡‰ç¯„ä¾‹ï¼ˆä½æº«ï¼‰**ï¼š
```json
{
  "ok": true,
  "action": "turn_off",
  "state": {
    "aircon": false
  },
  "target": 26.0
}
```

**å›æ‡‰ç¯„ä¾‹ï¼ˆæœªæä¾›æº«åº¦ï¼‰**ï¼š
```json
{
  "ok": false,
  "msg": "temp required",
  "usage": "è«‹åœ¨ URL åŠ ä¸Šæº«åº¦åƒæ•¸ï¼Œä¾‹å¦‚: /auto/decide?temp=28",
  "examples": {
    "é«˜æº«æ¸¬è©¦(é–‹å†·æ°£)": "/auto/decide?temp=28",
    "ä½æº«æ¸¬è©¦(é—œå†·æ°£)": "/auto/decide?temp=24",
    "è‡¨ç•Œæº«åº¦": "/auto/decide?temp=26.0"
  },
  "info": "ç›®æ¨™æº«åº¦è¨­å®šç‚º 26.0Â°Cï¼Œé«˜æ–¼æ­¤æº«åº¦æœƒé–‹å†·æ°£"
}
```

**å‰ç«¯éœ€æ±‚**ï¼š
- [ ] å»ºç«‹ã€Œæº«åº¦è‡ªå‹•æ§åˆ¶ã€é é¢
- [ ] é¡¯ç¤ºç•¶å‰æº«åº¦è¼¸å…¥æ¡†ï¼ˆå¯æ‰‹å‹•è¼¸å…¥æˆ–å¾æ„Ÿæ¸¬å™¨è®€å–ï¼‰
- [ ] é¡¯ç¤ºç›®æ¨™æº«åº¦ï¼ˆ26Â°Cï¼‰
- [ ] é¡¯ç¤ºå†·æ°£ç‹€æ…‹ï¼ˆé–‹å•Ÿ/é—œé–‰ï¼‰
- [ ] ç”¨**æº«åº¦è¨ˆåœ–ç¤º**æˆ–**å„€è¡¨æ¿**è¦–è¦ºåŒ–æº«åº¦
- [ ] é¡¯ç¤ºå»ºè­°å‹•ä½œï¼ˆé–‹å†·æ°£/é—œå†·æ°£ï¼‰

---

## ğŸ¨ å»ºè­°çš„å‰ç«¯æŠ€è¡“é¸æ“‡

### é¸é … Aï¼šç´” HTML + JavaScriptï¼ˆç°¡å–®ï¼‰
- ä½¿ç”¨ `fetch()` æˆ– `axios` å‘¼å« API
- ç”¨ Chart.js æˆ– ECharts ç¹ªè£½åœ–è¡¨
- é©åˆå¿«é€ŸåŸå‹é–‹ç™¼

### é¸é … Bï¼šå‰ç«¯æ¡†æ¶ï¼ˆæ¨è–¦ï¼‰
- **React** + Ant Design / Material-UI
- **Vue.js** + Element Plus
- **Next.js**ï¼ˆå¦‚æœéœ€è¦ SSRï¼‰

### é¸é … Cï¼šFlask æ¨¡æ¿æ¸²æŸ“ï¼ˆæœ€ç°¡å–®ï¼‰
- åœ¨ Flask ä¸­ç›´æ¥ä½¿ç”¨ Jinja2 æ¨¡æ¿
- å¾Œç«¯å…ˆè™•ç†è³‡æ–™ï¼Œç›´æ¥å‚³çµ¦ HTML é¡¯ç¤º
- ä¸éœ€è¦é¡å¤–çš„å‰ç«¯æ¡†æ¶

---

## ğŸ“ å»ºè­°çš„é é¢çµæ§‹

```
templates/
â”œâ”€â”€ base.html                    # æ¯æ¿ï¼ˆå°èˆªåˆ—ã€å…±ç”¨æ¨£å¼ï¼‰
â”œâ”€â”€ index.html                   # é¦–é ï¼ˆåŠŸèƒ½å…¥å£ï¼‰
â”œâ”€â”€ device/
â”‚   â””â”€â”€ control.html            # è¨­å‚™æ§åˆ¶é é¢
â”œâ”€â”€ usage/
â”‚   â”œâ”€â”€ daily.html              # æ¯æ—¥ç”¨é›»çµ±è¨ˆ
â”‚   â”œâ”€â”€ monthly.html            # æœˆçµ±è¨ˆ
â”‚   â”œâ”€â”€ yearly.html             # å¹´çµ±è¨ˆ
â”‚   â”œâ”€â”€ bill_calculator.html   # é›»è²»è©¦ç®—
â”‚   â”œâ”€â”€ compare.html            # æ™‚é–“æ®µæ¯”è¼ƒ
â”‚   â”œâ”€â”€ add_record.html         # æ–°å¢ç”¨é›»è¨˜éŒ„
â”‚   â””â”€â”€ batch_import.html       # æ‰¹æ¬¡åŒ¯å…¥
â””â”€â”€ auto/
    â””â”€â”€ temperature.html        # æº«åº¦è‡ªå‹•æ§åˆ¶
```

---

## ğŸ”— API ç«¯é»ç¸½è¦½

### åŠŸèƒ½ 1ï¼šè¨­å‚™æ§åˆ¶
| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/device/state` | æŸ¥çœ‹æ‰€æœ‰è¨­å‚™ç‹€æ…‹ |
| PATCH | `/device/toggle` | åˆ‡æ›è¨­å‚™é–‹é—œ |

### åŠŸèƒ½ 2ï¼šç”¨é›»çµ±è¨ˆ
| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/usage/daily` | æ¯æ—¥ç”¨é›»çµ±è¨ˆï¼ˆé è¨­è¿‘ 7 å¤©ï¼‰ |
| GET | `/usage/daily?start_date=<date>&end_date=<date>` | æŒ‡å®šæ—¥æœŸç¯„åœçš„æ¯æ—¥ç”¨é›» |
| GET | `/usage/monthly/<year>/<month>` | å–®æœˆç”¨é›»çµ±è¨ˆ |
| GET | `/usage/yearly/<year>` | å…¨å¹´ç”¨é›»çµ±è¨ˆ |
| POST | `/usage/bill` | é›»è²»è©¦ç®— |
| GET | `/usage/compare` | æ™‚é–“æ®µæ¯”è¼ƒ |
| POST | `/usage/add` | æ–°å¢å–®ç­†ç”¨é›»è¨˜éŒ„ |
| POST | `/usage/batch` | æ‰¹æ¬¡æ–°å¢ç”¨é›»è¨˜éŒ„ |

### åŠŸèƒ½ 3ï¼šæº«åº¦æ§åˆ¶
| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/auto/decide?temp=<temperature>` | æº«åº¦åˆ¤æ–·ï¼ˆGETï¼‰ |
| POST | `/auto/decide` | æº«åº¦åˆ¤æ–·ï¼ˆPOSTï¼‰ |

---

## ğŸ”— å°èˆªé€£çµå»ºè­°

åœ¨ `templates/base.html` æˆ– `index.html` ä¸­åŠ å…¥ï¼š

```html
<nav>
  <a href="/">é¦–é </a>
  
  <!-- åŠŸèƒ½1ï¼šé›»å™¨æ§åˆ¶ -->
  <a href="/device/state">è¨­å‚™ç‹€æ…‹</a>
  
  <!-- åŠŸèƒ½2ï¼šç”¨é›»çµ±è¨ˆ -->
  <a href="/usage/daily">æ¯æ—¥ç”¨é›»</a>
  <a href="/usage/monthly/2025/11">11æœˆçµ±è¨ˆ</a>
  <a href="/usage/yearly/2025">2025å¹´çµ±è¨ˆ</a>
  <a href="/usage/bill">é›»è²»è©¦ç®—</a>
  <a href="/usage/compare?period_type=month&date1=2025-10&date2=2025-11">æ™‚é–“æ®µæ¯”è¼ƒ</a>
  
  <!-- åŠŸèƒ½3ï¼šæº«åº¦æ§åˆ¶ -->
  <a href="/auto/decide?temp=25">æº«åº¦æ§åˆ¶</a>
</nav>
```

---

## ğŸ§ª æ¸¬è©¦ç”¨ API å‘¼å«ç¯„ä¾‹

### JavaScript Fetch ç¯„ä¾‹

```javascript
// ===== åŠŸèƒ½ 1ï¼šè¨­å‚™æ§åˆ¶ =====

// 1. å–å¾—è¨­å‚™ç‹€æ…‹
fetch('/device/state')
  .then(response => response.json())
  .then(data => {
    console.log('è¨­å‚™ç‹€æ…‹:', data.state);
  });

// 2. åˆ‡æ›è¨­å‚™é–‹é—œ
fetch('/device/toggle', {
  method: 'PATCH',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({name: 'å®¢å»³å†·æ°£', on: true})
})
  .then(response => response.json())
  .then(data => {
    console.log('æ›´æ–°å¾Œç‹€æ…‹:', data.state);
  });

// ===== åŠŸèƒ½ 2ï¼šç”¨é›»çµ±è¨ˆ =====

// 3. å–å¾—æ¯æ—¥ç”¨é›»ï¼ˆé è¨­è¿‘ 7 å¤©ï¼‰
fetch('/usage/daily')
  .then(response => response.json())
  .then(data => {
    console.log('æ¯æ—¥ç”¨é›»:', data.data);
    console.log('çµ±è¨ˆæ‘˜è¦:', data.summary);
  });

// 4. å–å¾—æ¯æ—¥ç”¨é›»ï¼ˆæŒ‡å®šæ—¥æœŸç¯„åœï¼‰
fetch('/usage/daily?start_date=2025-11-01&end_date=2025-11-30')
  .then(response => response.json())
  .then(data => {
    console.log('11æœˆæ¯æ—¥ç”¨é›»:', data.data);
  });

// 5. å–å¾—å–®æœˆçµ±è¨ˆ
fetch('/usage/monthly/2025/11')
  .then(response => response.json())
  .then(data => {
    console.log('11æœˆçµ±è¨ˆ:', data.summary);
    console.log('æ¯æ—¥æ˜ç´°:', data.data);
  });

// 6. å–å¾—å…¨å¹´çµ±è¨ˆ
fetch('/usage/yearly/2025')
  .then(response => response.json())
  .then(data => {
    console.log('2025å¹´çµ±è¨ˆ:', data.summary);
    console.log('å„æœˆæ˜ç´°:', data.data);
  });

// 7. é›»è²»è©¦ç®—
fetch('/usage/bill', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({kwh: 330, month: 7})
})
  .then(response => response.json())
  .then(data => {
    console.log('ç¸½é›»è²»:', data.total_bill);
    console.log('åˆ†æ®µæ˜ç´°:', data.breakdown);
  });

// 8. æ™‚é–“æ®µæ¯”è¼ƒï¼ˆæœˆä»½ï¼‰
fetch('/usage/compare?period_type=month&date1=2025-10&date2=2025-11')
  .then(response => response.json())
  .then(data => {
    console.log('10æœˆ:', data.period1);
    console.log('11æœˆ:', data.period2);
    console.log('å·®ç•°:', data.comparison);
  });

// 9. æ–°å¢ç”¨é›»è¨˜éŒ„
fetch('/usage/add', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    device_id: 1,
    kwh: 5.5,
    date: '2025-11-30'
  })
})
  .then(response => response.json())
  .then(data => {
    console.log('æ–°å¢æˆåŠŸ:', data.data);
  });

// 10. æ‰¹æ¬¡æ–°å¢ç”¨é›»è¨˜éŒ„
fetch('/usage/batch', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    records: [
      {device_id: 1, kwh: 5.5, date: '2025-11-01'},
      {device_id: 2, watts: 1000, hours: 3, date: '2025-11-01'},
      {device_id: 3, kwh: 2.3}
    ]
  })
})
  .then(response => response.json())
  .then(data => {
    console.log('æˆåŠŸ:', data.success_count);
    console.log('å¤±æ•—:', data.failure_count);
    console.log('æ˜ç´°:', data.results);
  });

// ===== åŠŸèƒ½ 3ï¼šæº«åº¦æ§åˆ¶ =====

// 11. æº«åº¦åˆ¤æ–·ï¼ˆGETï¼‰
fetch('/auto/decide?temp=28')
  .then(response => response.json())
  .then(data => {
    console.log('å‹•ä½œ:', data.action);
    console.log('å†·æ°£ç‹€æ…‹:', data.state.aircon);
  });

// 12. æº«åº¦åˆ¤æ–·ï¼ˆPOSTï¼‰
fetch('/auto/decide', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({temp: 24})
})
  .then(response => response.json())
  .then(data => {
    console.log('å‹•ä½œ:', data.action);
    console.log('å†·æ°£ç‹€æ…‹:', data.state.aircon);
  });
```

### PowerShell æ¸¬è©¦ç¯„ä¾‹

```powershell
# 1. å–å¾—æ¯æ—¥ç”¨é›»
Invoke-RestMethod -Uri "http://127.0.0.1:5000/usage/daily"

# 2. å–å¾— 11 æœˆçµ±è¨ˆ
Invoke-RestMethod -Uri "http://127.0.0.1:5000/usage/monthly/2025/11"

# 3. é›»è²»è©¦ç®—
$body = @{kwh=330; month=7} | ConvertTo-Json
Invoke-RestMethod -Uri "http://127.0.0.1:5000/usage/bill" -Method POST -ContentType "application/json" -Body $body

# 4. æ–°å¢ç”¨é›»è¨˜éŒ„
$body = @{device_id=1; kwh=5.5; date="2025-11-30"} | ConvertTo-Json
Invoke-RestMethod -Uri "http://127.0.0.1:5000/usage/add" -Method POST -ContentType "application/json" -Body $body

# 5. æ™‚é–“æ®µæ¯”è¼ƒ
Invoke-RestMethod -Uri "http://127.0.0.1:5000/usage/compare?period_type=month&date1=2025-10&date2=2025-11"

# 6. æº«åº¦åˆ¤æ–·
Invoke-RestMethod -Uri "http://127.0.0.1:5000/auto/decide?temp=28"
```

---

## ğŸ“Š åœ–è¡¨å»ºè­°

| åŠŸèƒ½ | å»ºè­°åœ–è¡¨é¡å‹ |
|------|-------------|
| æ¯æ—¥ç”¨é›»è¶¨å‹¢ | æŠ˜ç·šåœ– (Line Chart) |
| æœˆçµ±è¨ˆ | é•·æ¢åœ– (Bar Chart) |
| å¹´çµ±è¨ˆ | é•·æ¢åœ– + é¡è‰²å€åˆ†å¤å­£/éå¤å­£ |
| é›»è²»åˆ†æ®µ | å †ç–Šé•·æ¢åœ– (Stacked Bar) |
| æœˆä»½æ¯”è¼ƒ | ä¸¦æ’é•·æ¢åœ– (Grouped Bar) æˆ–é›·é”åœ– |
| æº«åº¦æ§åˆ¶ | å„€è¡¨æ¿ (Gauge) æˆ–æº«åº¦è¨ˆåœ–ç¤º |
| è¨­å‚™ç‹€æ…‹ | Toggle Switch é–‹é—œå…ƒä»¶ |

---

## âœ… å‰ç«¯é–‹ç™¼æª¢æŸ¥æ¸…å–®

### åŸºç¤æ•´åˆ
- [ ] ç¢ºèªå¾Œç«¯ä¼ºæœå™¨é‹è¡Œåœ¨ `http://127.0.0.1:5000`
- [ ] æ¸¬è©¦æ‰€æœ‰ API ç«¯é»æ˜¯å¦æ­£å¸¸å›æ‡‰
- [ ] å»ºç«‹åŸºç¤é é¢çµæ§‹å’Œå°èˆª

### åŠŸèƒ½1ï¼šè¨­å‚™æ§åˆ¶
- [ ] è¨­å‚™ç‹€æ…‹åˆ—è¡¨é é¢
- [ ] é–‹é—œåˆ‡æ›åŠŸèƒ½
- [ ] éŒ¯èª¤è™•ç†ï¼ˆè¨­å‚™ä¸å­˜åœ¨ã€ç¶²è·¯éŒ¯èª¤ï¼‰

### åŠŸèƒ½2ï¼šç”¨é›»çµ±è¨ˆ
- [ ] æ¯æ—¥ç”¨é›»é é¢ï¼ˆå«æ—¥æœŸé¸æ“‡å™¨ï¼‰
- [ ] æœˆçµ±è¨ˆé é¢ï¼ˆå«å¹´æœˆé¸æ“‡å™¨ï¼‰
- [ ] å¹´çµ±è¨ˆé é¢ï¼ˆå«å¹´ä»½é¸æ“‡å™¨ï¼‰
- [ ] é›»è²»è©¦ç®—é é¢ï¼ˆå«è¡¨å–®ï¼‰
- [ ] æ™‚é–“æ®µæ¯”è¼ƒé é¢ï¼ˆæ—¥/æœˆ/å¹´æ¯”è¼ƒï¼Œå«å…©å€‹æ—¥æœŸé¸æ“‡å™¨ï¼‰
- [ ] æ–°å¢ç”¨é›»è¨˜éŒ„è¡¨å–®
- [ ] æ‰¹æ¬¡åŒ¯å…¥åŠŸèƒ½ï¼ˆCSV/Excel ä¸Šå‚³ï¼‰
- [ ] åœ–è¡¨è¦–è¦ºåŒ–ï¼ˆChart.js / EChartsï¼‰

### åŠŸèƒ½3ï¼šæº«åº¦æ§åˆ¶
- [ ] æº«åº¦è¼¸å…¥/é¡¯ç¤ºä»‹é¢
- [ ] å†·æ°£ç‹€æ…‹é¡¯ç¤º
- [ ] è‡ªå‹•åˆ¤æ–·é‚è¼¯å‘ˆç¾

### ç¾åŒ–èˆ‡å„ªåŒ–
- [ ] RWD éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ‰‹æ©Ÿã€å¹³æ¿ã€é›»è…¦ï¼‰
- [ ] è¼‰å…¥å‹•ç•«ï¼ˆLoading Spinnerï¼‰
- [ ] éŒ¯èª¤æç¤ºï¼ˆToast / Alertï¼‰
- [ ] è³‡æ–™å¿«å–ï¼ˆæ¸›å°‘é‡è¤‡è«‹æ±‚ï¼‰

---

## ğŸ“ å¾Œç«¯è¯çµ¡è³‡è¨Š

å¦‚æœå‰ç«¯é–‹ç™¼éç¨‹ä¸­é‡åˆ°å•é¡Œï¼š
- API å›æ‡‰æ ¼å¼éœ€è¦èª¿æ•´
- éœ€è¦æ–°å¢æ¬„ä½æˆ–ç«¯é»
- è·¨åŸŸ CORS å•é¡Œ
- å…¶ä»–æ•´åˆå•é¡Œ

è«‹éš¨æ™‚èˆ‡å¾Œç«¯åœ˜éšŠè¯ç¹«è¨è«–ï¼

---

## ğŸ“‹ API åƒæ•¸å¿«é€Ÿåƒè€ƒ

### `/usage/daily` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜ |
|------|------|------|--------|------|
| `start_date` | string | âŒ | 7 å¤©å‰ | èµ·å§‹æ—¥æœŸ (YYYY-MM-DD) |
| `end_date` | string | âŒ | ä»Šå¤© | çµæŸæ—¥æœŸ (YYYY-MM-DD) |

### `/usage/monthly/<year>/<month>` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| `year` | int | âœ… | å¹´ä»½ (2025) |
| `month` | int | âœ… | æœˆä»½ (1-12) |

### `/usage/yearly/<year>` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| `year` | int | âœ… | å¹´ä»½ (2025) |

### `/usage/bill` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| `kwh` | float | âœ… | ç”¨é›»åº¦æ•¸ |
| `month` | int | âœ… | æœˆä»½ (1-12ï¼Œå½±éŸ¿å¤å­£/éå¤å­£è²»ç‡) |

### `/usage/compare` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜ |
|------|------|------|--------|------|
| `period_type` | string | âŒ | `month` | æ¯”è¼ƒé¡å‹ (`day`, `month`, `year`) |
| `date1` | string | âœ… | - | ç¬¬ä¸€å€‹æ™‚é–“é» |
| `date2` | string | âœ… | - | ç¬¬äºŒå€‹æ™‚é–“é» |

**date æ ¼å¼ç¯„ä¾‹**ï¼š
- `period_type=day`: `date1=2025-11-01`
- `period_type=month`: `date1=2025-10`
- `period_type=year`: `date1=2025`

### `/usage/add` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| `device_id` | int | âœ… | è¨­å‚™ ID |
| `kwh` | float | âœ… | ç”¨é›»åº¦æ•¸ |
| `date` | string | âŒ | è¨˜éŒ„æ—¥æœŸ (YYYY-MM-DD)ï¼Œé è¨­ç‚ºä»Šå¤© |

### `/usage/batch` åƒæ•¸
```json
{
  "records": [
    {
      "device_id": int,      // å¿…å¡«
      "kwh": float,          // é¸é … 1ï¼šç›´æ¥æä¾›åº¦æ•¸
      "watts": float,        // é¸é … 2ï¼šæä¾›ç“¦æ•¸å’Œæ™‚æ•¸
      "hours": float,        // é¸é … 2ï¼šæä¾›ç“¦æ•¸å’Œæ™‚æ•¸
      "date": string         // å¯é¸ï¼Œé è¨­ç‚ºä»Šå¤©
    }
  ]
}
```

### `/auto/decide` åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| `temp` | float | âœ… | ç•¶å‰æº«åº¦ï¼ˆÂ°Cï¼‰ |

---

## ğŸ¯ å¸¸è¦‹ä½¿ç”¨æƒ…å¢ƒç¯„ä¾‹

### æƒ…å¢ƒ 1ï¼šé¡¯ç¤ºæœ¬æœˆç”¨é›»è¶¨å‹¢
```javascript
const now = new Date();
const year = now.getFullYear();
const month = now.getMonth() + 1;

fetch(`/usage/monthly/${year}/${month}`)
  .then(response => response.json())
  .then(data => {
    // ç¹ªè£½æŠ˜ç·šåœ–
    drawLineChart(data.data);
  });
```

### æƒ…å¢ƒ 2ï¼šæ¯”è¼ƒä¸Šæœˆå’Œæœ¬æœˆç”¨é›»
```javascript
const now = new Date();
const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
const lastMonth = `${now.getFullYear()}-${String(now.getMonth()).padStart(2, '0')}`;

fetch(`/usage/compare?period_type=month&date1=${lastMonth}&date2=${thisMonth}`)
  .then(response => response.json())
  .then(data => {
    const change = data.comparison.kwh_percent_change;
    console.log(`ç”¨é›»é‡è®ŠåŒ–: ${change > 0 ? 'å¢åŠ ' : 'æ¸›å°‘'} ${Math.abs(change)}%`);
  });
```

### æƒ…å¢ƒ 3ï¼šè©¦ç®—ä¸åŒç”¨é›»é‡çš„é›»è²»
```javascript
const usageScenarios = [100, 200, 330, 500, 700, 1000];

Promise.all(
  usageScenarios.map(kwh =>
    fetch('/usage/bill', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({kwh, month: 7})
    }).then(r => r.json())
  )
).then(results => {
  // ç¹ªè£½é›»è²»ç´šè·åœ–è¡¨
  drawBillComparisonChart(results);
});
```

### æƒ…å¢ƒ 4ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™
```javascript
// è§£æ CSV æª”æ¡ˆ
function parseCSV(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const lines = e.target.result.split('\n');
      const records = lines.slice(1).map(line => {
        const [device_id, kwh, date] = line.split(',');
        return {
          device_id: parseInt(device_id),
          kwh: parseFloat(kwh),
          date: date.trim()
        };
      });
      resolve(records);
    };
    reader.readAsText(file);
  });
}

// æ‰¹æ¬¡ä¸Šå‚³
document.getElementById('csvFile').addEventListener('change', async (e) => {
  const records = await parseCSV(e.target.files[0]);
  
  fetch('/usage/batch', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({records})
  })
  .then(response => response.json())
  .then(data => {
    alert(`æˆåŠŸ: ${data.success_count}, å¤±æ•—: ${data.failure_count}`);
  });
});
```

---

**æ–‡ä»¶ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-30  
**å¾Œç«¯ API å®Œæˆåº¦**: âœ… 100%  
**åŒ…å«å®Œæ•´ API èªªæ˜**: âœ… å…¨éƒ¨ 11 å€‹ç«¯é»
